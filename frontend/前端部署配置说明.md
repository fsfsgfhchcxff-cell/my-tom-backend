# 🎨 前端部署配置说明

## 📋 API 地址配置

前端已经配置为**智能切换 API 地址**：

- 🏠 **本地开发**：自动使用 `localhost:8081`（通过 proxy）
- ☁️ **生产部署**：使用环境变量 `REACT_APP_API_URL`

---

## 🔧 配置方式

### 方式1：使用环境变量（推荐）⭐

**Vercel 部署：**

1. 进入 Vercel Dashboard
2. 选择你的项目
3. 进入 **Settings** → **Environment Variables**
4. 添加变量：

   | Name | Value |
   |------|-------|
   | `REACT_APP_API_URL` | `https://你的后端.onrender.com` |

5. 点击 **Save**
6. 重新部署（Vercel 会自动触发）

**Netlify 部署：**

1. 进入 Netlify Dashboard
2. 选择你的站点
3. 进入 **Site settings** → **Build & deploy** → **Environment**
4. 点击 **Edit variables**
5. 添加：`REACT_APP_API_URL = https://你的后端.onrender.com`
6. 点击 **Save**
7. 触发新的部署

---

### 方式2：创建 .env.production 文件

在 `frontend/` 目录创建 `.env.production`：

```bash
REACT_APP_API_URL=https://你的后端.onrender.com
```

**⚠️ 注意：** 不要提交 `.env.production` 到 Git！

---

## 📝 代码说明

### API 配置文件

`src/config/api.js` 负责处理 API 地址：

```javascript
// 自动识别环境
const API_BASE_URL = process.env.REACT_APP_API_URL || '';

export const getApiUrl = (endpoint) => {
  // 生产环境：使用完整 URL
  // 开发环境：使用相对路径（通过 proxy）
  return API_BASE_URL ? `${API_BASE_URL}${endpoint}` : endpoint;
};
```

### 使用示例

所有组件中的 API 调用：

```javascript
// 导入配置
import { getApiUrl } from '../config/api';

// 使用
const response = await fetch(getApiUrl('/api/game/home/1'));
```

---

## 🧪 测试配置

### 本地测试

```bash
# 不设置环境变量，使用 proxy
npm start

# 访问 http://localhost:3000
# 会自动转发到 http://localhost:8081
```

### 生产环境测试

```bash
# 设置环境变量
export REACT_APP_API_URL=https://你的后端.onrender.com

# 构建
npm run build

# 测试构建产物（需要安装 serve）
npx serve -s build
```

---

## 🔍 验证配置

### 方法1：检查构建产物

```bash
npm run build

# 检查环境变量是否注入
cat build/static/js/main.*.js | grep "onrender.com"
```

### 方法2：使用测试页面

1. 部署后访问你的前端
2. 点击底部的 **"测试"** 按钮 🧪
3. 点击 **"开始测试"**
4. 查看测试结果中的 URL

---

## ⚠️ 常见问题

### 问题1: API 请求失败

**错误**：`ERR_CONNECTION_REFUSED` 或 `Network Error`

**原因**：
- 后端地址配置错误
- 后端服务未运行
- CORS 配置问题

**解决**：
1. 检查 `REACT_APP_API_URL` 是否正确
2. 确认后端服务正在运行
3. 检查后端 CORS 配置

---

### 问题2: 环境变量不生效

**症状**：生产环境仍然请求 localhost

**原因**：环境变量未正确设置或未重新构建

**解决**：
1. 确认变量名是 `REACT_APP_API_URL`（必须以 `REACT_APP_` 开头）
2. 在 Vercel/Netlify 保存环境变量后，**重新部署**
3. 清除浏览器缓存

---

### 问题3: CORS 错误

**错误**：`Access to fetch has been blocked by CORS policy`

**原因**：后端未允许前端域名

**解决**：在后端添加 CORS 配置

```java
// 后端 Controller 或全局配置
@CrossOrigin(origins = {
    "http://localhost:3000",  // 本地开发
    "https://你的前端.vercel.app"  // 生产环境
})
```

---

## 📦 proxy 配置说明

`package.json` 中的 `proxy` 仅用于**本地开发**：

```json
{
  "proxy": "http://localhost:8081"
}
```

**作用**：
- 开发时，所有 `/api/*` 请求自动转发到 `localhost:8081`
- **生产环境不生效**，必须使用环境变量

---

## 🎯 完整流程

### 开发环境

```bash
1. 启动后端：快速启动.bat (localhost:8081)
2. 启动前端：npm start (localhost:3000)
3. 前端请求 /api/* → proxy 转发 → localhost:8081
```

### 生产环境

```bash
1. 设置环境变量：REACT_APP_API_URL=https://后端.onrender.com
2. 构建：npm run build
3. 部署到 Vercel/Netlify
4. 前端请求 → 直接访问 Render 后端
```

---

## 📚 相关文件

- `src/config/api.js` - API 配置
- `src/components/*/` - 所有组件已更新
- `package.json` - proxy 配置（开发用）
- `.env.example` - 环境变量示例

---

## 🔄 更新代码流程

修改配置后：

```bash
# 1. 提交代码
git add .
git commit -m "🔧 更新 API 配置"
git push

# 2. Vercel 自动重新部署
# 3. 验证新配置是否生效
```

---

## ✅ 检查清单

部署前确认：

- [ ] `src/config/api.js` 文件存在
- [ ] 所有组件导入了 `getApiUrl`
- [ ] 所有 `fetch` 调用使用 `getApiUrl()`
- [ ] Vercel 环境变量已设置
- [ ] 后端 CORS 允许前端域名

---

**配置完成！现在前端可以自动适应开发和生产环境了！** 🎉

